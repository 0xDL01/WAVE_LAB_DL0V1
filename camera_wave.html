<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Camera Motion Wave</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #050608;
      color: #f5f5f5;
      font-family: system-ui, -apple-system, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 { margin: 16px 0 8px; font-size: 1.4rem; }
    #row {
      display: flex;
      gap: 16px;
      margin: 8px;
      flex-wrap: wrap;
      justify-content: center;
    }
    video {
      background: #000;
      border-radius: 8px;
      border: 1px solid #303543;
      max-width: 320px;
    }
    canvas {
      background: #05060a;
      border-radius: 8px;
      border: 1px solid #303543;
    }
    small { color: #888fa5; margin-top: 6px; }
  </style>
</head>
<body>
  <h1>ðŸ“· Camera Motion Wave</h1>
  <div id="row">
    <video id="cam" autoplay playsinline muted></video>
    <canvas id="wave" width="400" height="220"></canvas>
  </div>
  <small>Move your hand / phone in front of the camera. The green wave should spike with motion.</small>

  <script>
    const video = document.getElementById('cam');
    const canvas = document.getElementById('wave');
    const ctx = canvas.getContext('2d');

    const width = canvas.width;
    const height = canvas.height;
    const centerY = height / 2;
    const historyLen = 300;
    let motionHistory = new Array(historyLen).fill(0);
    let prevFrame = null;

    function drawGrid() {
      ctx.save();
      ctx.clearRect(0, 0, width, height);
      ctx.strokeStyle = '#202637';
      ctx.lineWidth = 1;
      // center line
      ctx.beginPath();
      ctx.moveTo(0, centerY);
      ctx.lineTo(width, centerY);
      ctx.stroke();
      ctx.restore();
    }

    function drawWave() {
      drawGrid();
      ctx.save();
      ctx.strokeStyle = '#66bb6a';
      ctx.lineWidth = 2;

      const usableWidth = width - 20;
      const leftPad = 10;
      const scale = height / 2.5; // vertical gain

      ctx.beginPath();
      for (let x = 0; x < usableWidth; x++) {
        const idx = Math.floor((x / usableWidth) * (historyLen - 1));
        const v = motionHistory[idx]; // 0..1
        const y = centerY - v * scale;
        const cx = leftPad + x;
        if (x === 0) ctx.moveTo(cx, y);
        else ctx.lineTo(cx, y);
      }
      ctx.stroke();
      ctx.restore();
    }

    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { width: 320, height: 240 },
          audio: false
        });
        video.srcObject = stream;

        video.addEventListener('loadedmetadata', () => {
          video.play();
          startMotionLoop();
        });
      } catch (err) {
        console.error('Camera error:', err);
        alert('Camera error: ' + err.name + ' â€“ check permissions & use http://localhost, not file://');
      }
    }

    function startMotionLoop() {
      const tempCanvas = document.createElement('canvas');
      const tctx = tempCanvas.getContext('2d');

      function step() {
        const vw = video.videoWidth;
        const vh = video.videoHeight;
        if (vw > 0 && vh > 0) {
          const w = 160;
          const h = 120;
          tempCanvas.width = w;
          tempCanvas.height = h;

          tctx.drawImage(video, 0, 0, w, h);
          const frame = tctx.getImageData(0, 0, w, h);
          const data = frame.data;

          if (!prevFrame) {
            prevFrame = new Uint8ClampedArray(data);
            motionHistory.push(0);
            motionHistory.shift();
          } else {
            let sumDiff = 0;
            const pixels = data.length / 4;

            for (let i = 0; i < data.length; i += 4) {
              // brightness current vs previous
              const r1 = data[i],   g1 = data[i+1],   b1 = data[i+2];
              const r0 = prevFrame[i], g0 = prevFrame[i+1], b0 = prevFrame[i+2];

              const y1 = 0.299*r1 + 0.587*g1 + 0.114*b1;
              const y0 = 0.299*r0 + 0.587*g0 + 0.114*b0;

              sumDiff += Math.abs(y1 - y0);
            }

            const avgDiff = sumDiff / pixels;    // 0..255
            let norm = avgDiff / 40;            // tune gain: 40 â‰ˆ good movement scale
            if (norm > 1) norm = 1;

            motionHistory.push(norm);
            motionHistory.shift();

            prevFrame.set(data);
          }
        }

        drawWave();
        requestAnimationFrame(step);
      }

      step();
    }

    drawGrid();
    startCamera();
  </script>
</body>
</html>
